import React, { useState, useRef, useEffect } from 'react';
import { 
  Sparkles, 
  Image as ImageIcon, 
  Wand2, 
  Download, 
  Copy, 
  RefreshCw, 
  Zap, 
  AlertCircle,
  LayoutTemplate,
  Check,
  Camera,
  Briefcase,
  Coffee,
  Palette,
  X // เพิ่มไอคอน X สำหรับปุ่ม Clear
} from 'lucide-react';

/**
 * ------------------------------------------------------------------
 * TYPES
 * ------------------------------------------------------------------
 */
export enum AppState {
  IDLE = 'IDLE',
  GENERATING_TEXT = 'GENERATING_TEXT',
  GENERATING_IMAGE = 'GENERATING_IMAGE',
  SUCCESS = 'SUCCESS',
  ERROR = 'ERROR'
}

export interface GeneratedImage {
  id: string;
  url: string;
  prompt: string;
  createdAt: number;
}

export type AspectRatio = '1:1' | '3:4' | '4:3' | '16:9' | '9:16';
export type StockStyle = 'General' | 'Business' | 'Lifestyle' | 'Beauty';

/**
 * ------------------------------------------------------------------
 * SERVICES (Gemini API Integration)
 * ------------------------------------------------------------------
 */
const apiKey = ""; // API Key injected by environment

// Helper for delays/retries
const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

async function generateWithRetry(url: string, payload: any, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      const response = await fetch(`${url}?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!response.ok) throw new Error(`API Error: ${response.status}`);
      return await response.json();
    } catch (e) {
      if (i === retries - 1) throw e;
      await delay(1000 * Math.pow(2, i));
    }
  }
}

export const generateImage = async (prompt: string, aspectRatio: AspectRatio): Promise<string> => {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict`;
  
  const payload = {
    instances: [
      { prompt: `${prompt} --aspect-ratio ${aspectRatio}` }
    ],
    parameters: {
      sampleCount: 1,
      aspectRatio: aspectRatio
    }
  };

  try {
    const response = await fetch(`${url}?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const result = await response.json();
    if (result.error) throw new Error(result.error.message);
    
    const base64 = result.predictions?.[0]?.bytesBase64Encoded;
    if (base64) {
      return `data:image/png;base64,${base64}`;
    }
    throw new Error("No image data returned");
  } catch (error) {
    console.error("Image generation error:", error);
    throw error;
  }
};

export const enhancePrompt = async (originalPrompt: string): Promise<string> => {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`;
  
  const systemPrompt = "You are an expert prompt engineer for AI image generation (Imagen/Midjourney). Your goal is to rewrite the user's simple prompt into a highly detailed, descriptive, and artistic prompt that yields high-quality, realistic, or stylized results depending on context. Focus on lighting, texture, composition, and mood. Respond ONLY with the enhanced prompt text.";
  
  const payload = {
    contents: [{ parts: [{ text: `Enhance this prompt for an AI image generator: "${originalPrompt}"` }] }],
    systemInstruction: { parts: [{ text: systemPrompt }] }
  };

  try {
    const data = await generateWithRetry(url, payload);
    return data.candidates?.[0]?.content?.parts?.[0]?.text || originalPrompt;
  } catch (error) {
    console.error("Enhance prompt error:", error);
    return originalPrompt; // Fallback
  }
};

export const generateStockPrompt = async (topic: string, style: StockStyle): Promise<string> => {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`;
  
  const styleGuides = {
    'General': 'versatile, commercial, high quality',
    'Business': 'professional, corporate, office setting, confident, success',
    'Lifestyle': 'candid, authentic, daily life, warm lighting, natural',
    'Beauty': 'high fashion, skincare, clean lighting, elegant, macro details'
  };

  const systemPrompt = `You are a professional stock photographer and prompt engineer. Create a commercially viable stock photo prompt for the topic provided. 
  Style: ${style} (${styleGuides[style]}).
  Include technical keywords like '8k resolution', 'highly detailed', 'soft lighting', 'depth of field'.
  Respond ONLY with the prompt text.`;

  const payload = {
    contents: [{ parts: [{ text: `Create a stock photo prompt for the topic: "${topic}"` }] }],
    systemInstruction: { parts: [{ text: systemPrompt }] }
  };

  try {
    const data = await generateWithRetry(url, payload);
    return data.candidates?.[0]?.content?.parts?.[0]?.text || topic;
  } catch (error) {
    console.error("Stock prompt error:", error);
    throw error;
  }
};

/**
 * ------------------------------------------------------------------
 * COMPONENTS
 * ------------------------------------------------------------------
 */

const Header = () => (
  <header className="bg-white border-b border-gray-100 sticky top-0 z-50">
    <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
      <div className="flex items-center gap-2">
        <div className="bg-gradient-to-tr from-blue-600 to-indigo-600 p-2 rounded-lg text-white">
          <Sparkles className="w-5 h-5" />
        </div>
        <div>
          <h1 className="font-bold text-xl text-slate-800 tracking-tight">Gemini Creative Studio</h1>
          <p className="text-[10px] font-medium text-slate-500 uppercase tracking-wider">AI Powered Workspace</p>
        </div>
      </div>
      <div className="hidden sm:flex items-center gap-4 text-sm font-medium text-slate-600">
        <span className="flex items-center gap-1.5 px-3 py-1 bg-slate-50 rounded-full border border-slate-200">
          <Zap className="w-3.5 h-3.5 text-amber-500" />
          <span>Pro Mode Active</span>
        </span>
      </div>
    </div>
  </header>
);

const PromptInput = ({ 
  prompt, 
  setPrompt, 
  aspectRatio, 
  setAspectRatio, 
  onGenerate, 
  onEnhance, 
  onGenerateStockPrompt, 
  onAutoRun, 
  isGenerating, 
  isEnhancing, 
  isGeneratingStock, 
  isAutoRunning 
}: any) => {
  const [stockTopic, setStockTopic] = useState('');

  const aspectRatios: { value: AspectRatio; label: string; icon: any }[] = [
    { value: '1:1', label: 'Square (1:1)', icon: LayoutTemplate },
    { value: '3:4', label: 'Portrait (3:4)', icon: LayoutTemplate },
    { value: '4:3', label: 'Landscape (4:3)', icon: LayoutTemplate },
    { value: '9:16', label: 'Story (9:16)', icon: LayoutTemplate },
    { value: '16:9', label: 'Cinema (16:9)', icon: LayoutTemplate },
  ];

  return (
    <div className="space-y-6">
      {/* Main Prompt Area */}
      <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
        <div className="flex justify-between items-center mb-3">
          <label className="text-sm font-semibold text-slate-700 flex items-center gap-2">
            <Wand2 className="w-4 h-4 text-indigo-500" />
            คำสั่งสร้างรูป (Prompt)
          </label>
          <button 
            onClick={onEnhance}
            disabled={isEnhancing || !prompt}
            className="text-xs font-medium text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 px-2 py-1 rounded-md transition-colors flex items-center gap-1 disabled:opacity-50"
          >
            {isEnhancing ? <RefreshCw className="w-3 h-3 animate-spin" /> : <Sparkles className="w-3 h-3" />}
            ช่วยคิดคำให้สวย
          </button>
        </div>
        <textarea
          value={prompt}
          onChange={(e) => setPrompt(e.target.value)}
          placeholder="อธิบายรูปภาพที่คุณต้องการ... (เช่น: แมวเปอร์เซียใส่แว่นกันแดด นั่งอยู่ริมชายหาดตอนพระอาทิตย์ตก)"
          className="w-full h-32 p-4 text-slate-700 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none resize-none transition-all placeholder:text-slate-400 text-sm leading-relaxed"
        />
        
        <div className="mt-4 flex flex-wrap gap-4 items-center justify-between">
            <div className="flex items-center gap-2 overflow-x-auto pb-2 sm:pb-0 scrollbar-hide">
              {aspectRatios.map((ratio) => (
                <button
                  key={ratio.value}
                  onClick={() => setAspectRatio(ratio.value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium border transition-all whitespace-nowrap ${
                    aspectRatio === ratio.value
                      ? 'bg-slate-800 text-white border-slate-800'
                      : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300'
                  }`}
                >
                  <span className={`block w-3 h-3 border border-current rounded-sm ${
                    ratio.value === '1:1' ? 'aspect-square' :
                    ratio.value === '3:4' ? 'aspect-[3/4]' :
                    ratio.value === '4:3' ? 'aspect-[4/3]' :
                    ratio.value === '9:16' ? 'aspect-[9/16]' : 'aspect-video'
                  }`} />
                  {ratio.label}
                </button>
              ))}
            </div>
        </div>

        <button
          onClick={onGenerate}
          disabled={isGenerating || !prompt}
          className="w-full mt-4 bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-medium py-3 px-4 rounded-xl shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2 active:scale-[0.98]"
        >
          {isGenerating ? (
            <>
              <RefreshCw className="w-5 h-5 animate-spin" />
              กำลังสร้างสรรค์ผลงาน...
            </>
          ) : (
            <>
              <Sparkles className="w-5 h-5" />
              สร้างรูปภาพ (Generate)
            </>
          )}
        </button>
      </div>

      {/* Stock Photo Helper Section */}
      <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative">
        <div className="absolute top-0 right-0 p-3 opacity-5 pointer-events-none">
          <Camera className="w-32 h-32" />
        </div>
        
        <h3 className="text-sm font-semibold text-slate-800 mb-4 flex items-center gap-2">
          <Camera className="w-4 h-4 text-emerald-600" />
          Stock Photo Generator
        </h3>

        <div className="space-y-3">
          <div className="relative">
            <input
              type="text"
              value={stockTopic}
              onChange={(e) => setStockTopic(e.target.value)}
              placeholder="หัวข้อภาพ Stock (เช่น: ประชุมงาน, กาแฟยามเช้า, ออกกำลังกาย)"
              className="w-full px-4 py-2 pr-10 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"
            />
            {stockTopic && (
              <button
                onClick={() => setStockTopic('')}
                className="absolute right-2 top-1/2 -translate-y-1/2 p-1 text-slate-400 hover:text-slate-600 bg-transparent hover:bg-slate-100 rounded-full transition-colors"
                title="ล้างข้อความ"
              >
                <X className="w-4 h-4" />
              </button>
            )}
          </div>

          <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
             {[
               { id: 'General', icon: ImageIcon, label: 'ทั่วไป' },
               { id: 'Business', icon: Briefcase, label: 'ธุรกิจ' },
               { id: 'Lifestyle', icon: Coffee, label: 'ไลฟ์สไตล์' },
               { id: 'Beauty', icon: Palette, label: 'บิวตี้' }
             ].map((item) => (
               <button
                 key={item.id}
                 onClick={() => onGenerateStockPrompt(stockTopic || item.label, item.id as StockStyle)}
                 disabled={isGeneratingStock}
                 className="flex flex-col items-center justify-center gap-1.5 p-3 rounded-xl border border-slate-100 bg-slate-50 hover:bg-emerald-50 hover:border-emerald-200 text-slate-600 hover:text-emerald-700 transition-all text-xs font-medium active:scale-95"
               >
                 {/* @ts-ignore */}
                 <item.icon className="w-4 h-4 mb-0.5" />
                 {item.label}
               </button>
             ))}
          </div>

          <button
            onClick={async () => {
              await onAutoRun(stockTopic || 'Business Meeting', 'Business');
              setStockTopic('');
            }}
            disabled={isAutoRunning}
            className="w-full mt-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium py-2.5 rounded-lg flex items-center justify-center gap-2 transition-all shadow-sm hover:shadow-md disabled:opacity-70 disabled:cursor-not-allowed"
          >
             {isAutoRunning ? (
                <>
                  <RefreshCw className="w-4 h-4 animate-spin" />
                  Auto Running...
                </>
             ) : (
                <>
                  <Zap className="w-4 h-4 text-yellow-300 fill-yellow-300" />
                  Run Auto (คิดคำ + สร้างรูป + โหลด)
                </>
             )}
          </button>
        </div>
      </div>
    </div>
  );
};

const ImageResult = ({ image, loading }: { image: GeneratedImage | null, loading: boolean }) => {
  const [copied, setCopied] = useState(false);

  const handleCopyPrompt = () => {
    if (image?.prompt) {
      // Use document.execCommand('copy') as a fallback for iframe restrictions
      // where navigator.clipboard might be blocked
      const textArea = document.createElement("textarea");
      textArea.value = image.prompt;
      
      // Ensure the textarea is not visible but part of the DOM
      textArea.style.position = "fixed";
      textArea.style.left = "-9999px";
      textArea.style.top = "0";
      document.body.appendChild(textArea);
      
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        } else {
           console.error('Fallback: Copying text command was unsuccessful');
        }
      } catch (err) {
        console.error('Fallback: Oops, unable to copy', err);
      }
      
      document.body.removeChild(textArea);
    }
  };

  const handleDownload = () => {
    if (image?.url) {
      const link = document.createElement('a');
      link.href = image.url;
      link.download = `gemini-create-${image.id}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  };

  return (
    <div className="h-full min-h-[500px] flex flex-col">
      <div className="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative group">
        {loading ? (
          <div className="absolute inset-0 flex flex-col items-center justify-center bg-slate-50 z-10">
            <div className="relative w-20 h-20 mb-4">
              <div className="absolute inset-0 border-4 border-indigo-100 rounded-full"></div>
              <div className="absolute inset-0 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div>
            </div>
            <p className="text-slate-500 font-medium animate-pulse">กำลังวาดภาพจินตนาการ...</p>
            <p className="text-xs text-slate-400 mt-2">Gemini AI</p>
          </div>
        ) : image ? (
          <div className="relative h-full flex items-center justify-center bg-slate-900">
             <img 
               src={image.url} 
               alt="Generated" 
               className="max-w-full max-h-full object-contain shadow-2xl"
             />
             <div className="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                <button 
                  onClick={handleDownload}
                  className="p-2 bg-white/90 backdrop-blur-sm rounded-lg hover:bg-white text-slate-700 shadow-lg transition-all"
                  title="Download"
                >
                  <Download className="w-5 h-5" />
                </button>
             </div>
          </div>
        ) : (
          <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-400 bg-slate-50/50">
             <div className="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mb-4 border border-slate-200">
               <ImageIcon className="w-10 h-10 opacity-50" />
             </div>
             <p className="font-medium text-slate-500">ยังไม่มีรูปภาพ</p>
             <p className="text-sm">พิมพ์คำสั่งแล้วกดสร้างรูปได้เลย</p>
          </div>
        )}
      </div>

      {image && !loading && (
        <div className="mt-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
           <div className="flex justify-between items-start gap-4">
             <div>
               <h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Prompt Used</h4>
               <p className="text-sm text-slate-700 leading-relaxed line-clamp-3 hover:line-clamp-none transition-all">
                 {image.prompt}
               </p>
             </div>
             <button 
               onClick={handleCopyPrompt}
               className="p-2 hover:bg-slate-100 rounded-lg text-slate-500 transition-colors flex-shrink-0"
               title="Copy Prompt"
             >
               {copied ? <Check className="w-4 h-4 text-green-500" /> : <Copy className="w-4 h-4" />}
             </button>
           </div>
        </div>
      )}
    </div>
  );
};

/**
 * ------------------------------------------------------------------
 * MAIN APP COMPONENT
 * ------------------------------------------------------------------
 */
const App: React.FC = () => {
  const [prompt, setPrompt] = useState<string>('');
  const [aspectRatio, setAspectRatio] = useState<AspectRatio>('3:4'); // Default to 3:4 for stock vertical
  const [appState, setAppState] = useState<AppState>(AppState.IDLE);
  const [currentImage, setCurrentImage] = useState<GeneratedImage | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [isGeneratingStock, setIsGeneratingStock] = useState(false);
  const [isAutoRunning, setIsAutoRunning] = useState(false);

  const handleGenerate = async () => {
    if (!prompt.trim()) return;

    setAppState(AppState.GENERATING_IMAGE);
    setError(null);

    try {
      const imageUrl = await generateImage(prompt, aspectRatio);
      const newImage: GeneratedImage = {
        id: crypto.randomUUID(),
        url: imageUrl,
        prompt: prompt,
        createdAt: Date.now(),
      };
      setCurrentImage(newImage);
      setAppState(AppState.SUCCESS);
    } catch (e: any) {
      console.error(e);
      setAppState(AppState.ERROR);
      setError("เกิดข้อผิดพลาดในการสร้างรูปภาพ กรุณาลองใหม่อีกครั้ง หรือลองเปลี่ยนคำสั่ง (API อาจไม่ตอบสนอง)");
    }
  };

  const handleEnhancePrompt = async () => {
    if (!prompt.trim()) return;
    
    setAppState(AppState.GENERATING_TEXT);
    try {
      const enhanced = await enhancePrompt(prompt);
      setPrompt(enhanced);
      setAppState(AppState.IDLE);
    } catch (e) {
      console.error("Enhance failed", e);
      setAppState(AppState.IDLE);
    }
  };

  const handleGenerateStockPrompt = async (topic: string, style: StockStyle) => {
    setIsGeneratingStock(true);
    try {
      const stockPrompt = await generateStockPrompt(topic, style);
      setPrompt(stockPrompt);
    } catch (e) {
      console.error("Stock prompt generation failed", e);
      setError("ไม่สามารถสร้าง Prompt ได้ กรุณาลองใหม่อีกครั้ง");
    } finally {
      setIsGeneratingStock(false);
    }
  };

  const handleAutoRun = async (topic: string, style: StockStyle) => {
    if (!topic.trim()) return;

    setIsAutoRunning(true);
    setError(null);
    setAppState(AppState.GENERATING_TEXT); // Start with text generation state

    try {
      // Step 1: Generate Prompt
      const stockPrompt = await generateStockPrompt(topic, style);
      setPrompt(stockPrompt);

      // Step 2: Generate Image
      setAppState(AppState.GENERATING_IMAGE);
      // Small delay to ensure state updates visually if needed
      await new Promise(resolve => setTimeout(resolve, 800)); 
      
      const imageUrl = await generateImage(stockPrompt, aspectRatio);
      const newImage: GeneratedImage = {
        id: crypto.randomUUID(),
        url: imageUrl,
        prompt: stockPrompt,
        createdAt: Date.now(),
      };
      setCurrentImage(newImage);
      setAppState(AppState.SUCCESS);

      // Step 3: Auto Download
      // Note: In some iframe environments auto-download might be blocked, but we'll try.
      try {
        const link = document.createElement('a');
        link.href = imageUrl;
        link.download = `gemini-stock-${Date.now()}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (dlError) {
        console.warn("Auto download blocked:", dlError);
      }

    } catch (e) {
      console.error("Auto Run Failed", e);
      setAppState(AppState.ERROR);
      setError("เกิดข้อผิดพลาดในขั้นตอน Auto Run กรุณาลองใหม่");
    } finally {
      setIsAutoRunning(false);
      setIsGeneratingStock(false); 
      // appState will remain SUCCESS or ERROR based on flow
    }
  };

  return (
    <div className="min-h-screen flex flex-col bg-[#F8F9FA] font-sans text-slate-900">
      <Header />

      <main className="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Error Alert */}
        {error && (
          <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3 text-red-700 animate-fadeIn shadow-sm">
            <AlertCircle className="w-5 h-5 mt-0.5 flex-shrink-0" />
            <div>
              <h3 className="font-medium text-sm">เกิดข้อผิดพลาด</h3>
              <p className="text-sm mt-1 text-red-600 opacity-90">{error}</p>
            </div>
          </div>
        )}

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
          {/* Left Column: Controls */}
          <div className="lg:col-span-5 space-y-6">
            <div className="sticky top-24 space-y-6">
               <PromptInput 
                 prompt={prompt}
                 setPrompt={setPrompt}
                 aspectRatio={aspectRatio}
                 setAspectRatio={setAspectRatio}
                 onGenerate={handleGenerate}
                 onEnhance={handleEnhancePrompt}
                 onGenerateStockPrompt={handleGenerateStockPrompt}
                 onAutoRun={handleAutoRun}
                 isGenerating={appState === AppState.GENERATING_IMAGE}
                 isEnhancing={appState === AppState.GENERATING_TEXT}
                 isGeneratingStock={isGeneratingStock}
                 isAutoRunning={isAutoRunning}
               />
               
               <div className="bg-gradient-to-br from-amber-50 to-orange-50 border border-amber-100 rounded-xl p-5 shadow-sm">
                  <h4 className="text-sm font-bold text-amber-900 mb-3 flex items-center gap-2">
                    <Sparkles className="w-4 h-4 text-amber-600" />
                    เคล็ดลับมือโปร (Pro Tips)
                  </h4>
                  <ul className="text-xs sm:text-sm text-amber-800 space-y-2 list-disc list-inside opacity-90 leading-relaxed">
                    <li>ฟีเจอร์ใหม่! ใส่แค่ "หัวข้อ" ด้านบน แล้วให้ AI คิด Prompt แบบมืออาชีพให้</li>
                    <li><strong>ปุ่ม ⚡ Run Auto:</strong> เหมาะสำหรับทำ Stock Photo ระบบจะคิดคำ+สร้าง+โหลดให้ทันที</li>
                    <li>ระบบจะใส่ Tag สำคัญ (8k resolution, photorealistic) ให้โดยอัตโนมัติในโหมด Stock</li>
                    <li>สัดส่วนภาพแนะนำ: 3:4 (แนวตั้งขายดี) หรือ 16:9 (Cinematic)</li>
                  </ul>
               </div>
            </div>
          </div>

          {/* Right Column: Result */}
          <div className="lg:col-span-7">
            <ImageResult 
              image={currentImage} 
              loading={appState === AppState.GENERATING_IMAGE} 
            />
          </div>
        </div>
      </main>
    </div>
  );
};

export default App;
